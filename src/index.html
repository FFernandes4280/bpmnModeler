<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BPMN Modeler</title>
  <style>
    body {
      display: flex;
      margin: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
    }

    #form-container {
      width: 25%;
      padding: 20px;
      box-sizing: border-box;
      background-color: #f4f4f4;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }

    #diagram-container {
      flex-grow: 1;
      position: relative;
    }

    #canvas {
      width: 100%;
      height: 100%;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }

    input, textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      box-sizing: border-box;
    }

    select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div id="form-container">
    <form id="bpmnForm">
      <label for="session">ID da sessão para restreabilidade:</label>
      <input type="text" id="session" name="session" required>

      <label for="processName">Nome do processo:</label>
      <input type="text" id="processName" name="processName" required>

      <label for="participants">Participantes (Separados por vírgula):</label>
      <input type="text" id="participants" name="participants" required>

      <label for="hasExternalParticipants">Possui participantes externos?</label>
      <select id="hasExternalParticipants" name="hasExternalParticipants">
        <option value="Não">Não</option>
        <option value="Sim">Sim</option>
      </select>

      <div id="externalParticipantsContainer" style="display: none;">
        <label for="externalParticipants">Participantes externos (Separados por vírgula):</label>
        <input type="text" id="externalParticipants" name="externalParticipants">
      </div>

      <label for="initialEventName">Nome do evento inicial:</label>
      <input type="text" id="initialEventName" name="initialEventName" required>

      <label for="initialEventLane">Lane do evento inicial:</label>
      <input type="text" id="initialEventLane" name="initialEventLane" required>

      <label for="elements">Elementos:</label>
      <textarea id="elements" name="elements" rows="10" required></textarea>

    </form>
  </div>

  <div id="diagram-container">
    <div id="canvas"></div>
  </div>

  <script type="module">
    import BpmnViewer from 'bpmn-js';
    import { generateDiagramFromInput } from './chatbot.js';

    const viewer = new BpmnViewer({ container: '#canvas' });

    document.getElementById('session').value = Math.floor(Math.random() * 1000000);
    
    // Função para gerar e atualizar o diagrama
    async function updateDiagram() {
      const session = document.getElementById('session').value;
      const processName = document.getElementById('processName').value || 'Default Process';
      const participantsInput = document.getElementById('participants').value.split(',').map(participant => participant.trim());
      const hasExternalParticipants = document.getElementById('hasExternalParticipants').value;
      const externalParticipantsInput = document.getElementById('externalParticipants').value.split(',').map(participant => participant.trim());
      const initialEventName = document.getElementById('initialEventName').value;
      const initialEventLane = document.getElementById('initialEventLane').value;
      const elements = [];

      try {
        const diagramXML = await generateDiagramFromInput(
          processName,
          participantsInput,
          hasExternalParticipants,
          externalParticipantsInput,
          initialEventName,
          initialEventLane,
          elements
        );

        await viewer.importXML(diagramXML);
        const canvas = viewer.get('canvas');

        // Implement drag behavior
        let isPanning = false;
        let lastMousePosition = { x: 0, y: 0 };

        const canvasElement = document.querySelector('#canvas');

        canvasElement.addEventListener('mousedown', (event) => {
          isPanning = true;
          lastMousePosition = { x: event.clientX, y: event.clientY };
        });

        canvasElement.addEventListener('mousemove', (event) => {
          if (!isPanning) return;

          const deltaX = event.clientX - lastMousePosition.x;
          const deltaY = event.clientY - lastMousePosition.y;

          canvas.scroll({
            dx: deltaX,
            dy: deltaY,
          });

          lastMousePosition = { x: event.clientX, y: event.clientY };
        });

        canvasElement.addEventListener('mouseup', () => {
          isPanning = false;
        });

        canvasElement.addEventListener('mouseleave', () => {
          isPanning = false;
        });
      } catch (err) {
        console.error('Failed to load diagram:', err);
      }
    }

    // Atualiza o diagrama a cada 2000ms
    setInterval(updateDiagram, 2000);

    const hasExternalParticipantsSelect = document.getElementById('hasExternalParticipants');
    const externalParticipantsContainer = document.getElementById('externalParticipantsContainer');

    hasExternalParticipantsSelect.addEventListener('change', () => {
      if (hasExternalParticipantsSelect.value === 'Sim') {
        externalParticipantsContainer.style.display = 'block';
      } else {
        externalParticipantsContainer.style.display = 'none';
      }
    });
  </script>
</body>
</html>